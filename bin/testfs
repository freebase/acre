#!/usr/bin/env python

import sys
import os
import test_driver
import tempfile
import subprocess

manifest=tempfile.mkstemp(dir="/tmp", prefix="fsmanifest.")[1]

# check api endpoint
subprocess.check_call('bin/freebase_check')

site_addr =os.environ['ACRE_FREEBASE_SITE_ADDR']
acre_port = os.environ['ACRE_PORT']
acre_host_base = os.environ['ACRE_HOST_BASE']

url = 'http://%s:%s/status' % (site_addr, acre_port)
args = ['curl', '-s', '-S', '-o', '/dev/null', url]
sys.stdout.write('CHECK: %s...' % url)
subprocess.check_call(args)
sys.stdout.write('PASSED\n')

args = ['bin/discover_tests.py', '-n', acre_host_base,
    '-p', acre_port,
    '-e', site_addr ]
# add the callers args
if len(sys.argv) > 1:
    if sys.argv[1] == '--help':
        args = ['bin/discover_tests.py', '--help']
        subprocess.check_call(args)
        sys.exit(0)
    args = args + sys.argv[1:]

subprocess.check_call(args, stdout=open(manifest,'w'))
print "tests were found, test manifest has been created:", manifest, '\nrun tests...\n'
sys.argv = ['', '-j', manifest]
sys.exit(test_driver.main())
