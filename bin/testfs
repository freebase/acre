#!/usr/bin/env python
#
# the script finds tests on disk and looks up the url path (route) for that app
# the output is an input for ./acre testfs, then runs them with the acre test driver
# 
import sys
import os
import json
import urllib2
import re
import test_driver

# assuming we're in the root of acre, find tests in www
base_path = os.path.split(os.path.abspath(os.path.join(__file__,'..')))[0]
www_path = base_path + '/' + \
  'webapp/WEB-INF/scripts/googlecode/freebase-site/svn/trunk/www'

def discover(host, port, env, nomock, whitelist):
    params = '?output=flatjson'
    if nomock:
        params += '&mock=0'
    else:
        params += '&mock=1'
    url = "http://%s:%s/_fs_routing"\
    % (env, port)
    try:
        response = urllib2.urlopen(url)
    except:
        sys.stderr.write("error fetching: %s\n" % url)
        sys.stderr.write("perhaps you need to add %s to /etc/hosts?\n\n" % host)
        raise
    data = json.loads(response.read())
    
    apps = {}
    for p in data['prefix']:
        appurl = p.get('app')
        prefix = p.get('prefix')
        if appurl:
            m = re.match('//([^\.]+)\.www[^\/]+(/.*$|$)', appurl)
            if not m: continue
            app = m.groups()[0]
            path = app + m.groups()[1]
            apps[path] = prefix
    
    test_paths = {}
    os.chdir(www_path)
    fls = os.popen("find . -name test_*sjs").read().split('\n')
    manifest = {}
    for f in fls:
        if not f: break
        tfile = f[2:].split('/')
        tapp = tfile[0]
        if whitelist and tapp not in whitelist: continue
        if not manifest.get(tapp):
            manifest[tapp] = []
        tpath = tfile[:len(tfile)-1]
        fl = tfile[len(tfile)-1:][0]
        i = len(tpath)
        found = False
        # start with an exact match then try the parent 
        while i > 0:
            path = '/'.join(tpath[:i])
            remainder = '/'
            if len(tpath) > i:
                remainder = '/' + '/'.join(tpath[i:]) + '/'
            
            i = i - 1
            if apps.get(path):
                #print tpath, path
                found = True
                manifest[tapp].append("http://" + env + ":" +\
                  port + apps[path] + remainder + fl + params)
                #print  apps[path] + remainder + fl + "?output=flatjson"
                break
        if not found: sys.stderr.write("WARN: did not find a route for: %s\n" % f)
    
    ret = manifest
    return ret

def run_tests(manifest, color, jsn, env, port):
    os.chdir(base_path)
    cmd = 'curl -s -S http://%s:%s/status > /dev/null' % (env, port)
    sys.stdout.write('CHECK: acre status...')
    if os.system(cmd) != 0:
        print "FAILED"
        sys.exit(1)
    sys.stdout.write('PASSED\n')

    sys.stdout.write('CHECK: freebase endpoint...')
    cmd = 'bin/freebase_check > /dev/null'
    if os.system(cmd) != 0:
        print "FAILED"
        sys.exit(1)
    sys.stdout.write('PASSED\n')

    return test_driver.drive_apps(manifest, color, jsn)

from optparse import OptionParser
def main(argv=None):
    if argv is None:
        argv = sys.argv

    usage = "usage: discover_tests.py [--help] optional args are whitelisted apps"
    parser = OptionParser(usage=usage)
    parser.add_option('-j',  dest='jsn', action="store_true", help='enable test driver output json')
    parser.add_option('-n',  dest='nocolor', action="store_true", help='disable test driver sans terminal colors')
    parser.add_option('-m',  dest='nomock', action="store_true", help='disable the default backend mockmode')
    (opts, args) = parser.parse_args(argv)
    color = True
    if opts.nocolor: color = False
    jsn = False
    if opts.jsn: jsn = True
    nomock = False
    if opts.nomock: nomock = True
   
    env = os.environ['ACRE_FREEBASE_SITE_ADDR']
    port = os.environ['ACRE_PORT']
    host = os.environ['ACRE_HOST_BASE']
    manifest = discover(host, port, env, nomock, args[1:])
    sys.exit(run_tests(manifest, color, jsn, env, port))
    

if __name__ == '__main__':
    sys.exit(main())
